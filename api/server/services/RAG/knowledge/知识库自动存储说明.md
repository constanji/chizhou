# 知识库自动存储说明

## 当前存储方式

### 现状：支持两种存储方式

1. **手动存储**（已实现）- 通过 API 端点手动添加
2. **自动存储**（已实现）- 通过 QA提取智能体自动提取 QA 对

## 存储方式详解

### 方式1: 手动存储（API 调用）

通过调用 API 端点手动添加知识条目。

#### API 端点

- **单个添加**: `POST /api/rag/knowledge`
- **批量添加**: `POST /api/rag/knowledge/batch`

#### 使用示例

```javascript
// 添加QA对
fetch('/api/rag/knowledge', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer YOUR_JWT_TOKEN'
  },
  body: JSON.stringify({
    type: 'qa_pair',
    data: {
      question: '什么是RAG？',
      answer: 'RAG是检索增强生成技术',
      entityId: 'data_source_id' // 可选：关联数据源
    }
  })
});
```

### 方式2: 自动存储（QA提取智能体）

系统使用 **QA提取智能体**（QA Extractor Agent）自动从对话中提取有价值的QA对并存储到知识库。

#### 工作流程

```
用户发送消息
    ↓
AI 生成回复
    ↓
【并行执行】
  ├─ 主智能体：生成回复给用户
  └─ QA提取智能体：分析对话
      ↓
    LLM判断是否有价值的QA对
      ↓
    调用 add_qa_pair 工具
      ↓
    去重检查（KnowledgeBaseService.checkDuplicateQA）
    ↓
    存储到知识库
      ├─ MongoDB (KnowledgeEntry)
      └─ PostgreSQL (qa_pair_vectors)
```

#### 配置

QA提取智能体通过 `Because.yaml` 配置：

```yaml
qaExtractor:
  disabled: false                    # 是否禁用
  messageWindowSize: 5               # 消息窗口大小
  minQuestionLength: 5               # 问题最小长度
  minAnswerLength: 10               # 答案最小长度
  agent:
    provider: deepseek               # LLM提供商
    model: deepseek-chat             # LLM模型
    instructions: |                  # 提取指令
      你是一个智能QA对提取助手...
    model_parameters:
      temperature: 0.2               # 模型参数
```

#### 提取规则

QA提取智能体使用LLM智能判断，根据配置的 `instructions` 识别有价值的QA对：

1. **识别标准**：
   - 用户提出了明确的问题（包含疑问词或问号）
   - AI提供了有意义的回答（不是"抱歉"、"我不确定"等）
   - 问题和答案都有实际价值，不是临时性的闲聊

2. **去重机制**：
   - 自动检查知识库中是否已存在相同或相似的QA对
   - 使用精确匹配和向量相似度匹配（阈值0.85）
   - 如果指定了 `entityId`，只在同一数据源内检查重复

3. **数据源隔离**：
   - 自动关联到Agent配置的 `data_source_id`
   - 不同数据源可以有相同的问题（这是合理的）

## 相关文档

- **QA提取智能体详细说明**: `docs/rag/QA对自动提取智能体说明.md`
- **QA对处理优化说明**: `docs/rag/QA对处理优化说明.md`
- **知识库数据结构**: `api/server/services/RAG/knowledge/知识库数据结构说明.md`

## 代码位置

- **QA提取智能体**: `packages/api/src/agents/qaExtractor.ts`
- **AgentClient集成**: `api/server/controllers/agents/client.js`
- **知识库服务**: `api/server/services/RAG/KnowledgeBaseService.js`
- **去重检查**: `KnowledgeBaseService.checkDuplicateQA()`

## 注意事项

1. **配置要求**：
   - 需要在 `Because.yaml` 中配置 `qaExtractor` 段
   - 确保 `qaExtractor.disabled = false`

2. **数据源关联**：
   - 如果Agent配置了 `data_source_id`，QA对会自动关联到该数据源
   - 如果未配置，QA对存储为共享知识库

3. **去重机制**：
   - 自动去重，避免重复存储
   - 相似度阈值默认0.85，可在代码中调整

4. **性能考虑**：
   - QA提取是异步的，不阻塞主对话流程
   - 去重检查会增加一次数据库查询，但影响很小

---

**最后更新**: 2025-01-XX  
**维护者**: BecauseChat开发团队
