## 构建说明

### 项目结构

```
aichatClone/
├── packages/
│   ├── data-provider/    # 数据提供层
│   ├── data-schemas/     # 数据模式定义
│   ├── api/              # API 包（MCP 服务）
│   └── client/           # 客户端组件包
├── agents-Aipyq/         # Agents 核心库
├── api/                  # 后端服务器
└── client/               # 前端应用
```

### 构建顺序

1. **packages/data-provider** - 基础数据提供层  
2. **packages/data-schemas** - 数据模式（依赖 data-provider）  
3. **packages/api** - API 包（依赖 data-provider, data-schemas）  
4. **packages/client** - 客户端包（依赖 data-provider）  
5. **client** - 前端应用（依赖所有 packages）

### 各包的构建配置

#### packages/api

- **构建工具**: `rollup-plugin-typescript2`
- **特殊配置**: 
  - `check: false` - 跳过类型检查（避免内存问题）
  - `exclude: ['node_modules/**']` - 排除 node_modules

#### packages/data-provider

- **构建工具**: `rollup-plugin-typescript2`
- **配置**: `check: false` - 跳过类型检查

#### packages/data-schemas

- **构建工具**: `@rollup/plugin-typescript`
- **配置**: 标准 TypeScript 构建

#### packages/client

- **构建工具**: `rollup-plugin-typescript2`
- **配置**: `check: false` - 跳过类型检查

## 常见问题

### 1. 内存不足错误

**错误信息**:
```
FATAL ERROR: Ineffective mark-compacts near heap limit
Allocation failed - JavaScript heap out of memory
```

**解决方案**:
- `packages/api` 已配置使用 `rollup-plugin-typescript2` 并跳过类型检查
- 如果仍有问题，可以增加内存限制：
  ```bash
  export NODE_OPTIONS="--max-old-space-size=16384"
  npm run build:api
  ```

### 2. 找不到模块 @aipyq/api

**错误信息**:
```
Error: Cannot find module '@aipyq/api/dist/index.js'
```

**解决方案**:
```bash
# 重新安装依赖以刷新工作区链接
npm install

# 确保 packages/api 已构建
npm run build:api
```

### 3. 找不到 client/dist/index.html

**错误信息**:
```
ENOENT: no such file or directory, open 'client/dist/index.html'
```

**解决方案**:
```bash
# 构建前端应用
cd client
npm run build
```

### 4. 类型声明文件缺失

**说明**: 
- `agents-Aipyq` 的类型声明文件（`.d.ts`）是可选的
- 构建时已设置 `skipLibCheck: true`，不会影响构建
- IDE 仍会进行类型检查

### 5. 环境变量警告

**警告信息**:
```
warn: Default value for JWT_SECRET is being used.
```

**解决方案**:
1. 访问 https://www.aipyq.com/toolkit/creds_generator 生成密钥
2. 在 `.env` 文件中设置：
   ```
   JWT_SECRET=your-secret-key
   JWT_REFRESH_SECRET=your-refresh-secret
   CREDS_KEY=your-creds-key
   CREDS_IV=your-creds-iv
   ```

### 6. MongoDB 连接错误

**错误信息**:
```
Error: Please define the MONGO_URI environment variable
```

**解决方案**:
- 在 `.env` 文件中设置 `MONGO_URI`
- 或使用 Docker 模式（自动配置）

### 7. 配置文件版本过旧

**警告信息**:
```
Outdated Config version: 1.2.1
Latest version: 1.3.1
```

**解决方案**:
- 查看更新日志: https://www.aipyq.com/changelog
- 根据需要更新 `Aipyq.yaml` 配置

## 启动方式

### 开发模式

#### 本地开发（推荐用于开发）

```bash
# 终端 1: 后端（支持热重载）
npm run backend:dev

# 终端 2: 前端（Vite 开发服务器）
npm run frontend:dev
```

**访问地址**:
- 前端: http://localhost:5173 (Vite 默认端口)
- 后端: http://localhost:3080

#### Docker 开发模式（推荐用于测试）

```bash
# 启动所有服务
docker-compose -f docker-compose.dev.yml up -d

# 查看日志
docker-compose -f docker-compose.dev.yml logs -f

# 停止服务
docker-compose -f docker-compose.dev.yml down
```

**访问地址**:
- 前端: http://localhost:3090
- 后端: http://localhost:3080
- MongoDB: localhost:27018
- Meilisearch: localhost:7700

### 生产模式

```bash
# 构建所有包
npm run build:packages

# 构建前端
cd client && npm run build

# 启动后端（服务前端静态文件）
npm run backend
```

**访问地址**: http://localhost:3080

## 验证部署

### 检查构建状态

```bash
# 检查所有包的构建状态
for pkg in packages/data-provider packages/data-schemas packages/api packages/client; do
  echo "=== $pkg ==="
  test -d "$pkg/dist" && echo "✅ dist 存在" || echo "❌ dist 不存在"
  test -d "$pkg/dist/types" && echo "✅ types 存在" || echo "⚠️  types 不存在"
done

# 检查前端构建
test -f client/dist/index.html && echo "✅ 前端已构建" || echo "❌ 前端未构建"
```

### 检查服务状态

```bash
# 检查后端是否运行
curl http://localhost:3080/api/health

# 检查前端是否可访问
curl http://localhost:3090
```


